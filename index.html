<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiệm giấy Thứ Ba - Quản lý kinh doanh</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Plus Jakarta Sans', 'Inter', 'system-ui', 'sans-serif'] 
                    },
                    colors: {
                        brand: { 500: '#ea580c', 600: '#c2410c' }, 
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 700: '#475569', 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            -webkit-font-smoothing: antialiased;
        }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .nav-active { 
            background-color: #fef2e0;
            color: #ea580c !important;
            border-right: 3px solid #ea580c;
        }

        .input-focus:focus {
            outline: none;
            border-color: #ea580c;
            box-shadow: 0 0 0 4px rgba(234, 88, 12, 0.1);
        }

        .card-shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        }

        .btn-transition {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const App = () => {
            // --- State ---
            const [activeTab, setActiveTab] = useState('dashboard');
            const [materials, setMaterials] = useState([]);
            const [purchases, setPurchases] = useState([]);
            const [products, setProducts] = useState([]);
            const [showNotification, setShowNotification] = useState(null);
            
            // Edit States
            const [editingMatId, setEditingMatId] = useState(null);
            const [newProduct, setNewProduct] = useState({ name: '', recipe: [] });
            
            const fileInputRef = useRef(null);

            // --- Persistence ---
            useEffect(() => {
                const data = {
                    materials: JSON.parse(localStorage.getItem('tg_materials_v16') || '[]'),
                    purchases: JSON.parse(localStorage.getItem('tg_purchases_v16') || '[]'),
                    products: JSON.parse(localStorage.getItem('tg_products_v16') || '[]')
                };
                setMaterials(data.materials);
                setPurchases(data.purchases);
                setProducts(data.products);
            }, []);

            useEffect(() => {
                localStorage.setItem('tg_materials_v16', JSON.stringify(materials));
                localStorage.setItem('tg_purchases_v16', JSON.stringify(purchases));
                localStorage.setItem('tg_products_v16', JSON.stringify(products));
            }, [materials, purchases, products]);

            const notify = (msg) => {
                setShowNotification(msg);
                setTimeout(() => setShowNotification(null), 3000);
            };

            // --- Logic ---
            const materialCosts = useMemo(() => {
                const costs = {};
                materials.forEach(m => {
                    const matPurchases = purchases.filter(p => p.materialId === m.id);
                    if (matPurchases.length === 0) { costs[m.id] = 0; return; }
                    
                    const totalQty = matPurchases.reduce((sum, p) => sum + Number(p.quantity), 0);
                    const totalVal = matPurchases.reduce((sum, p) => sum + Number(p.totalBatchPrice), 0);
                    costs[m.id] = totalQty > 0 ? totalVal / totalQty : 0;
                });
                return costs;
            }, [materials, purchases]);

            const calculateProductCOGS = (product) => {
                let total = 0;
                product.recipe.forEach(item => {
                    const price = Number(item.price) || 0;
                    const amount = Number(item.amount) || 0;
                    const wastage = Number(item.wastage) || 0;
                    const costWithWastage = (amount * price) / (1 - (wastage / 100));
                    total += costWithWastage;
                });
                return total;
            };

            // --- Handlers ---
            const addMaterial = (e) => {
                e.preventDefault();
                const name = e.target.name.value.trim();
                const unit = e.target.unit.value.trim();
                if (!name || !unit) return;
                
                if (editingMatId) {
                    setMaterials(materials.map(m => m.id === editingMatId ? { ...m, name, unit } : m));
                    setEditingMatId(null);
                    notify("Đã cập nhật nguyên liệu");
                } else {
                    setMaterials([...materials, { id: Date.now().toString(), name, unit }]);
                    notify("Đã thêm nguyên liệu mới");
                }
                e.target.reset();
            };

            const addPurchase = (e) => {
                e.preventDefault();
                const materialId = e.target.materialId.value;
                const quantity = Number(e.target.quantity.value);
                const totalBatchPrice = Number(e.target.totalBatchPrice.value);
                
                if (!materialId || !quantity || !totalBatchPrice) return;
                
                setPurchases([...purchases, { 
                    id: Date.now().toString(), 
                    materialId, 
                    quantity, 
                    totalBatchPrice,
                    note: e.target.note.value || '',
                    date: e.target.date.value || new Date().toISOString().split('T')[0] 
                }]);
                e.target.reset();
                notify("Ghi nhận nhập kho thành công");
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n').slice(1);
                    const newPurchases = [];
                    rows.forEach(row => {
                        if (!row.trim()) return;
                        const columns = row.split(/[;,]/); 
                        if (columns.length < 4) return;
                        const [date, matName, qty, totalPrice, note] = columns.map(c => c ? c.trim() : '');
                        const material = materials.find(m => m.name.toLowerCase() === matName.toLowerCase());
                        if (material) {
                            newPurchases.push({
                                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                                materialId: material.id,
                                quantity: Number(qty) || 0,
                                totalBatchPrice: Number(totalPrice) || 0,
                                note: note || '',
                                date: date || new Date().toISOString().split('T')[0]
                            });
                        }
                    });
                    if (newPurchases.length > 0) {
                        setPurchases(prev => [...prev, ...newPurchases]);
                        notify(`Đã nhập thành công ${newPurchases.length} dòng`);
                    } else notify("Lỗi: Không tìm thấy nguyên liệu khớp");
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const addToRecipe = (materialId) => {
                const mat = materials.find(m => m.id === materialId);
                if (newProduct.recipe.find(r => r.materialId === materialId)) {
                    notify("Nguyên liệu này đã có trong công thức");
                    return;
                }
                const defaultPrice = materialCosts[materialId] || 0;
                setNewProduct({ 
                    ...newProduct, 
                    recipe: [
                        ...newProduct.recipe, 
                        { materialId, name: mat.name, amount: 1, price: Math.round(defaultPrice), wastage: 0, unit: mat.unit }
                    ] 
                });
            };

            const saveProduct = () => {
                if (!newProduct.name || newProduct.recipe.length === 0) return notify("Vui lòng điền đủ thông tin sản phẩm");
                setProducts([...products, { ...newProduct, id: Date.now().toString() }]);
                setNewProduct({ name: '', recipe: [] });
                notify("Lưu định mức thành công");
            };

            const deleteMaterial = (id) => {
                if (purchases.some(p => p.materialId === id)) {
                    notify("Không thể xóa: nguyên liệu đã có lịch sử nhập");
                    return;
                }
                if(confirm("Xóa nguyên liệu này khỏi danh mục?")) {
                    setMaterials(materials.filter(m => m.id !== id));
                }
            };

            const deletePurchase = (id) => {
                if(confirm("Xóa bản ghi nhập kho này?")) {
                    setPurchases(purchases.filter(p => p.id !== id));
                    notify("Đã xóa bản ghi");
                }
            };

            // --- Views ---
            const DashboardView = () => (
                <div className="flex-1 overflow-auto p-10 space-y-10">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div className="bg-white p-8 border border-slate-200 rounded-2xl card-shadow">
                            <p className="text-sm font-medium text-slate-500 mb-1">Nguyên liệu trong danh mục</p>
                            <p className="text-4xl font-bold text-slate-900 leading-none">{materials.length}</p>
                        </div>
                        <div className="bg-white p-8 border border-slate-200 rounded-2xl card-shadow">
                            <p className="text-sm font-medium text-slate-500 mb-1">Tổng lượt nhập kho</p>
                            <p className="text-4xl font-bold text-slate-900 leading-none">{purchases.length}</p>
                        </div>
                        <div className="bg-white p-8 border border-slate-200 rounded-2xl card-shadow border-b-4 border-b-brand-500">
                            <p className="text-sm font-medium text-brand-600 mb-1">Sản phẩm đã lập định mức</p>
                            <p className="text-4xl font-bold text-brand-600 leading-none">{products.length}</p>
                        </div>
                    </div>

                    <div className="bg-white border border-slate-200 rounded-2xl overflow-hidden card-shadow">
                        <div className="px-8 py-6 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                            <h3 className="font-bold text-slate-800 text-lg">Giá vốn nguyên liệu bình quân hiện tại</h3>
                            <button onClick={() => {
                                const bom = '\uFEFF';
                                const csv = "Nguyên liệu;Đơn vị;Giá bình quân\n" + materials.map(m => `${m.name};${m.unit};${Math.round(materialCosts[m.id])}`).join("\n");
                                const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
                                const link = document.createElement("a");
                                link.href = URL.createObjectURL(blob); link.download = "cogs_report.csv"; link.click();
                            }} className="text-xs font-semibold text-brand-600 hover:text-brand-700 transition-colors uppercase tracking-wider">Tải báo cáo CSV</button>
                        </div>
                        <table className="w-full text-left table-fixed">
                            <thead className="bg-slate-50 text-[11px] font-bold text-slate-400 border-b uppercase">
                                <tr>
                                    <th className="px-8 py-4 w-1/2">Tên nguyên liệu</th>
                                    <th className="px-8 py-4">Đơn vị</th>
                                    <th className="px-8 py-4 text-right">Giá bình quân / đơn vị</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-base">
                                {materials.map(m => (
                                    <tr key={m.id} className="hover:bg-slate-50 transition group">
                                        <td className="px-8 py-5 font-semibold text-slate-700">{m.name}</td>
                                        <td className="px-8 py-5 text-slate-500 font-medium">{m.unit}</td>
                                        <td className="px-8 py-5 text-right font-bold text-brand-600 tabular-nums">
                                            {Math.round(materialCosts[m.id]).toLocaleString()} đ
                                        </td>
                                    </tr>
                                ))}
                                {materials.length === 0 && <tr><td colSpan="3" className="py-20 text-center text-slate-300 font-medium">Chưa có dữ liệu nguyên liệu</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            return (
                <div className="flex h-full relative">
                    {/* Sidebar */}
                    <aside className="w-64 bg-slate-800 flex-shrink-0 flex flex-col z-20 shadow-xl">
                        <div className="h-28 flex items-center px-8 border-b border-slate-700/50">
                            <div className="flex flex-col">
                                <span className="text-[10px] font-bold text-brand-500 uppercase tracking-widest mb-1">Hệ thống quản lý</span>
                                <h1 className="text-white font-extrabold text-xl tracking-tight leading-none">tiệm giấy <span className="text-brand-500">Thứ Ba</span></h1>
                            </div>
                        </div>
                        
                        <nav className="flex-1 py-8">
                            {[
                                { id: 'dashboard', label: 'Báo cáo tổng quan' },
                                { id: 'inventory', label: 'Kho nguyên liệu' },
                                { id: 'products', label: 'Định mức sản phẩm' }
                            ].map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)} 
                                    className={`w-full flex items-center px-8 py-4 transition-all font-semibold text-sm text-left text-slate-400 hover:text-white hover:bg-slate-700/50 ${activeTab === item.id ? 'nav-active' : ''}`}
                                >
                                    {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-6 text-[10px] font-medium text-slate-500 text-center border-t border-slate-700/50 opacity-60">Version 16.0 Elegant</div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col min-w-0 bg-slate-50 relative h-full overflow-hidden">
                        <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-10 shadow-sm flex-shrink-0 z-10">
                            <h2 className="font-bold text-lg text-slate-700">
                                {activeTab === 'dashboard' ? 'Tổng quan doanh nghiệp' : activeTab === 'inventory' ? 'Quản lý kho hàng' : 'Cấu trúc sản phẩm'}
                            </h2>
                        </header>

                        <div className="flex-1 overflow-auto">
                            {activeTab === 'dashboard' && <DashboardView />}

                            {activeTab === 'inventory' && (
                                <div className="p-10 grid grid-cols-1 xl:grid-cols-3 gap-10">
                                    <div className="space-y-8">
                                        <div className="bg-white p-8 rounded-2xl border border-slate-200 card-shadow">
                                            <h3 className="font-bold text-slate-800 mb-6 text-base pb-3 border-b border-slate-50">
                                                {editingMatId ? 'Cập nhật nguyên liệu' : 'Thêm nguyên liệu mới'}
                                            </h3>
                                            <form onSubmit={addMaterial} className="space-y-5">
                                                <div>
                                                    <label className="text-[11px] font-bold text-slate-400 mb-1.5 block">Tên mặt hàng</label>
                                                    <input name="name" defaultValue={editingMatId ? materials.find(m => m.id === editingMatId)?.name : ''} placeholder="Giấy Kraft, gỗ thông..." className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus font-semibold" required />
                                                </div>
                                                <div>
                                                    <label className="text-[11px] font-bold text-slate-400 mb-1.5 block">Đơn vị đo lường</label>
                                                    <input name="unit" defaultValue={editingMatId ? materials.find(m => m.id === editingMatId)?.unit : ''} placeholder="gram, cm, cái..." className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus font-semibold" required />
                                                </div>
                                                <div className="flex gap-3 pt-2">
                                                    <button className="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold text-sm btn-transition hover:bg-slate-900 shadow-md">Lưu dữ liệu</button>
                                                    {editingMatId && <button type="button" onClick={() => setEditingMatId(null)} className="px-5 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">Hủy</button>}
                                                </div>
                                            </form>
                                        </div>

                                        <div className="bg-white p-8 rounded-2xl border border-slate-200 card-shadow">
                                            <h3 className="font-bold text-emerald-700 mb-6 text-base pb-3 border-b border-emerald-50">Ghi nhận nhập hàng</h3>
                                            <form onSubmit={addPurchase} className="space-y-5">
                                                <div>
                                                    <label className="text-[11px] font-bold text-slate-400 mb-1.5 block">Chọn nguyên liệu</label>
                                                    <select name="materialId" className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus font-bold appearance-none cursor-pointer" required>
                                                        <option value="">-- Click để chọn --</option>
                                                        {materials.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                                    </select>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="text-[11px] font-bold text-slate-400 mb-1.5 block">Số lượng nhập</label>
                                                        <input name="quantity" type="number" step="any" placeholder="0.00" className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus font-bold" required />
                                                    </div>
                                                    <div>
                                                        <label className="text-[11px] font-bold text-slate-400 mb-1.5 block">Tổng giá đợt hàng</label>
                                                        <input name="totalBatchPrice" type="number" placeholder="Tổng VNĐ" className="w-full px-4 py-3 bg-brand-50 border border-brand-100 rounded-xl input-focus font-bold text-brand-600" required />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-[11px] font-bold text-slate-400 mb-1.5 block">Ghi chú chi tiết</label>
                                                    <input name="note" placeholder="Màu sắc, kích cỡ, nhà cung cấp..." className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus font-medium" />
                                                </div>
                                                <div>
                                                    <label className="text-[11px] font-bold text-slate-400 mb-1.5 block">Ngày giao hàng</label>
                                                    <input name="date" type="date" className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl input-focus font-semibold" defaultValue={new Date().toISOString().split('T')[0]} />
                                                </div>
                                                <button className="w-full bg-emerald-600 text-white py-3.5 rounded-xl font-bold text-sm btn-transition hover:bg-emerald-700 shadow-md">Xác nhận nhập kho</button>
                                            </form>
                                        </div>
                                    </div>

                                    <div className="xl:col-span-2 space-y-10">
                                        <div className="bg-white rounded-2xl border border-slate-200 card-shadow overflow-hidden">
                                            <div className="px-8 py-5 border-b bg-slate-50/50">
                                                <h3 className="font-bold text-slate-700 text-sm">Danh mục nguyên vật liệu</h3>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-px bg-slate-100">
                                                {materials.map(m => (
                                                    <div key={m.id} className="bg-white p-6 flex justify-between items-center group btn-transition hover:bg-slate-50/50">
                                                        <div>
                                                            <p className="font-bold text-lg text-slate-800">{m.name}</p>
                                                            <p className="text-[11px] font-semibold text-slate-400 uppercase tracking-wider">{m.unit}</p>
                                                        </div>
                                                        <div className="flex gap-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={() => setEditingMatId(m.id)} className="text-xs font-bold text-slate-400 hover:text-brand-500">Sửa</button>
                                                            <button onClick={() => deleteMaterial(m.id)} className="text-xs font-bold text-slate-400 hover:text-red-500">Xóa</button>
                                                        </div>
                                                    </div>
                                                ))}
                                                {materials.length === 0 && <div className="bg-white p-12 text-center text-slate-300 col-span-2">Kho danh mục đang trống</div>}
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-2xl border border-slate-200 card-shadow overflow-hidden flex flex-col max-h-[650px]">
                                            <div className="px-8 py-6 border-b bg-slate-50/50 flex justify-between items-center">
                                                <h3 className="font-bold text-slate-700 text-sm">Nhật ký nhập kho chi tiết</h3>
                                                <div className="flex gap-5 items-center">
                                                    <input type="file" accept=".csv" className="hidden" ref={fileInputRef} onChange={handleFileUpload} />
                                                    <button onClick={() => fileInputRef.current.click()} className="text-[11px] font-bold text-slate-400 hover:text-slate-600 transition-colors uppercase">Nhập CSV</button>
                                                    <button onClick={() => { if(confirm("Xóa toàn bộ lịch sử?")) setPurchases([]); }} className="text-[11px] font-bold text-red-400 hover:text-red-600 transition-colors uppercase">Làm sạch</button>
                                                </div>
                                            </div>
                                            <div className="overflow-auto flex-1">
                                                <table className="w-full text-left text-sm">
                                                    <thead className="bg-slate-50 text-[10px] font-bold text-slate-400 border-b sticky top-0 uppercase tracking-wider">
                                                        <tr>
                                                            <th className="px-8 py-4">Ngày</th>
                                                            <th className="px-8 py-4">Sản phẩm & Chi chú</th>
                                                            <th className="px-8 py-4 text-right">Lượng</th>
                                                            <th className="px-8 py-4 text-right">Tổng giá</th>
                                                            <th className="px-6 py-4"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-100">
                                                        {[...purchases].reverse().map(p => (
                                                            <tr key={p.id} className="hover:bg-slate-50 transition group">
                                                                <td className="px-8 py-5 text-slate-400 font-medium">{p.date}</td>
                                                                <td className="px-8 py-5">
                                                                    <div className="font-bold text-slate-700">{materials.find(m => m.id === p.materialId)?.name}</div>
                                                                    {p.note && <div className="text-[11px] text-brand-600 font-medium mt-0.5">{p.note}</div>}
                                                                </td>
                                                                <td className="px-8 py-5 text-right font-bold text-slate-600">{p.quantity}</td>
                                                                <td className="px-8 py-5 text-right font-bold text-slate-900 tabular-nums">{Number(p.totalBatchPrice).toLocaleString()} đ</td>
                                                                <td className="px-4 py-5 text-right">
                                                                    <button onClick={() => deletePurchase(p.id)} className="text-slate-300 hover:text-red-500 font-bold opacity-0 group-hover:opacity-100 transition-all px-3">✕</button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'products' && (
                                <div className="p-10 grid grid-cols-1 lg:grid-cols-3 gap-12">
                                    <div className="space-y-8">
                                        <div className="bg-white p-8 rounded-2xl border border-slate-200 card-shadow">
                                            <h3 className="font-bold text-slate-800 mb-8 text-lg pb-4 border-b border-slate-50">Thiết lập sản phẩm mới</h3>
                                            <div className="space-y-8">
                                                <div>
                                                    <label className="text-[11px] font-bold text-slate-400 mb-2 block uppercase tracking-wider">Tên sản phẩm thành phẩm</label>
                                                    <input 
                                                        value={newProduct.name} 
                                                        onChange={e => setNewProduct({...newProduct, name: e.target.value})} 
                                                        placeholder="Nhập tên sản phẩm..." 
                                                        className="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-xl font-bold text-xl outline-none focus:border-brand-500 transition-all" 
                                                    />
                                                </div>
                                                
                                                <div>
                                                    <p className="text-[11px] font-bold text-slate-400 mb-3 uppercase tracking-wider">Kho nguyên liệu (Nhấp để chọn)</p>
                                                    <div className="flex flex-wrap gap-2 max-h-[180px] overflow-auto pr-2 custom-scrollbar">
                                                        {materials.map(m => (
                                                            <button 
                                                                key={m.id} 
                                                                onClick={() => addToRecipe(m.id)} 
                                                                className="px-4 py-2.5 bg-white text-slate-700 text-sm font-semibold rounded-xl border border-slate-200 hover:border-brand-500 hover:text-brand-600 transition-all shadow-sm"
                                                            >
                                                                + {m.name}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div className="bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200 flex flex-col">
                                                    <h4 className="font-bold text-slate-500 mb-6 text-xs uppercase tracking-widest text-center">Bảng định mức sử dụng (BOM)</h4>
                                                    <div className="space-y-4 max-h-[400px] overflow-auto pr-1 custom-scrollbar">
                                                        {newProduct.recipe.map((item, idx) => (
                                                            <div key={idx} className="bg-white p-5 rounded-xl border border-slate-200 space-y-4">
                                                                <div className="flex justify-between items-center border-b border-slate-50 pb-3">
                                                                    <span className="font-bold text-slate-800 uppercase text-xs tracking-tight">{item.name}</span>
                                                                    <button onClick={() => setNewProduct({...newProduct, recipe: newProduct.recipe.filter((_, i) => i !== idx)})} className="text-slate-300 hover:text-red-500 font-bold">✕</button>
                                                                </div>
                                                                <div className="grid grid-cols-2 gap-4">
                                                                    <div>
                                                                        <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Số lượng ({item.unit})</label>
                                                                        <input type="number" step="any" className="w-full bg-slate-50 px-3 py-2 rounded-lg font-bold text-slate-800 outline-none border border-transparent focus:border-slate-200" value={item.amount} onChange={e => { const updated = [...newProduct.recipe]; updated[idx].amount = e.target.value; setNewProduct({...newProduct, recipe: updated}); }} />
                                                                    </div>
                                                                    <div>
                                                                        <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Giá áp dụng (đ)</label>
                                                                        <input type="number" step="any" className="w-full bg-slate-50 px-3 py-2 rounded-lg font-bold text-brand-600 outline-none border border-transparent focus:border-brand-500" value={item.price} onChange={e => { const updated = [...newProduct.recipe]; updated[idx].price = e.target.value; setNewProduct({...newProduct, recipe: updated}); }} />
                                                                    </div>
                                                                </div>
                                                                <div>
                                                                    <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Hao hụt sản xuất (%)</label>
                                                                    <input type="number" step="any" className="w-full bg-slate-50 px-3 py-2 rounded-lg font-bold text-slate-600 outline-none" value={item.wastage} onChange={e => { const updated = [...newProduct.recipe]; updated[idx].wastage = e.target.value; setNewProduct({...newProduct, recipe: updated}); }} />
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {newProduct.recipe.length === 0 && <div className="py-12 text-center text-slate-300 text-sm font-medium italic">Chọn nguyên liệu phía trên để lập công thức</div>}
                                                    </div>
                                                    <button onClick={saveProduct} className="w-full bg-brand-600 text-white py-4 rounded-xl font-bold text-sm shadow-lg btn-transition hover:bg-brand-700 mt-8">Lưu sản phẩm định mức</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="lg:col-span-2 space-y-8 flex flex-col h-full overflow-hidden">
                                        <h3 className="font-bold text-slate-800 text-lg px-2">Danh sách thành phẩm</h3>
                                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-8 overflow-auto pr-2 pb-32 custom-scrollbar">
                                            {products.map(p => {
                                                const cogs = calculateProductCOGS(p);
                                                return (
                                                    <div key={p.id} className="bg-white rounded-2xl p-8 border border-slate-200 card-shadow transition-all h-fit group">
                                                        <div className="flex justify-between items-start mb-8">
                                                            <div className="flex-1">
                                                                <h4 className="text-xl font-bold text-slate-900 group-hover:text-brand-600 transition-colors leading-tight">{p.name}</h4>
                                                                <p className="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-widest">{p.recipe.length} nguyên liệu cấu thành</p>
                                                            </div>
                                                            <button onClick={() => { if(confirm("Xóa sản phẩm này?")) setProducts(products.filter(pr => pr.id !== p.id)); }} className="text-slate-200 hover:text-red-500 font-bold text-xl px-2 transition-colors">✕</button>
                                                        </div>

                                                        <div className="bg-slate-900 p-8 rounded-2xl mb-8 flex flex-col items-center">
                                                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em] mb-2">Tổng giá vốn dự kiến</p>
                                                            <p className="text-4xl font-bold text-brand-500 tabular-nums tracking-tighter">
                                                                {Math.round(cogs).toLocaleString()} <span className="text-lg font-medium">đ</span>
                                                            </p>
                                                        </div>

                                                        <div className="space-y-4 pt-6 border-t border-slate-50 text-sm">
                                                            {p.recipe.map((r, i) => (
                                                                <div key={i} className="flex justify-between items-center py-1">
                                                                    <div className="flex flex-col">
                                                                        <span className="font-bold text-slate-700">{r.name}</span>
                                                                        <span className="text-[10px] text-slate-400 font-medium italic">Giá gốc: {Number(r.price).toLocaleString()}đ | Hao hụt: {r.wastage}%</span>
                                                                    </div>
                                                                    <span className="font-bold text-slate-900 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100 tabular-nums">{r.amount} {r.unit}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Notification */}
                        {showNotification && (
                            <div className="fixed bottom-10 right-10 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center z-[100] animate-in slide-in-from-bottom-5 border-l-4 border-brand-500">
                                <span className="font-semibold text-sm">{showNotification}</span>
                                <button onClick={() => setShowNotification(null)} className="text-slate-400 hover:text-white font-bold ml-6">✕</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        window.addEventListener('load', () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        });
    </script>
</body>
</html>
